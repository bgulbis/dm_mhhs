---
title: "Diabetes in MHHS"
subtitle: "Exploratory Analysis"
author: "Brian Gulbis"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
    html_document:
        code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.table.format = "html")
```

```{r, message=FALSE}
library(tidyverse)
library(forcats)
library(plotly)
library(kableExtra)

x <- dirr::get_rds("../data/tidy")
```

```{r, fig.cap="Number of patients with any ICD-10-CM code for diabetes during an encounter at each facility. Data for each facility are split into type of visit (inpatient, emergency, or observation). Data represents a 4-month sample from fiscal year 2017."}
encounter_types <- c("Inpatient", "Emergency", "Observation")

count_facility <- dm_patients %>%
    filter(visit.type %in% encounter_types) %>%
    count(facility, sort = TRUE) %>%
    rename(n_pts = n)

dm_patients %>%
    filter(visit.type %in% encounter_types) %>%
    count(facility, visit.type, sort = TRUE) %>%
    left_join(count_facility, by = "facility") %>%
    arrange(desc(n_pts), desc(n)) %>%
    mutate_at("facility", as_factor) %>%
    mutate_at("facility", fct_rev) %>%
    plot_ly() %>%
    add_bars(x = ~n, y = ~facility, color = ~visit.type) %>%
    layout(barmode = "stack",
           xaxis = list(title = "Patients"),
           yaxis = list(title = "Facility", showgrid = FALSE),
           margin = list(l = 150))
```

```{r}
count_all <- all_inpatients %>%
    count(facility) %>%
    rename(n_all = n)

count_dm <- dm_patients %>%
    filter(visit.type == "Inpatient") %>%
    count(facility) %>%
    left_join(count_all, by = "facility") %>%
    mutate(pct_dm = n / n_all * 100) %>%
    arrange(desc(pct_dm)) %>%
    mutate_at("facility", as_factor) 
```

```{r, fig.cap="Percent of admitted patients with diabetes at each facility. The size of the dot corresponds to the total number of inpatients at each facility."}
count_dm %>%
    mutate_at("facility", fct_rev) %>%
    plot_ly() %>%
    add_markers(x = ~pct_dm, y = ~facility, size = ~n_all) %>%
    layout(barmode = "stack",
           xaxis = list(title = "Patients (%)"),
           yaxis = list(title = "Facility", showgrid = FALSE),
           margin = list(l = 150))
```

```{r}
count_dm %>%
    mutate(annual_n = (n_all / 4) * 12,
           annaul_dm = (n / 4) * 12) %>%
    select(Facility = facility, `Number of Patients` = annual_n, `Number with Diabetes` = annaul_dm, `Patients with Diabetes (%)` = pct_dm) %>%
    knitr::kable(digits = 0, caption = "Admitted patients with diabetes at each facility from fiscal year 2017[note]") %>%
    kable_styling(full_width = FALSE) %>%
    add_footnote("Number of patients is on an annual basis, estimated from a sample of four months throughout fiscal year 2017", notation = "symbol")
```
